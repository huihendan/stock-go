# 新回测系统使用指南

## 快速开始

### 1. 基本使用

```go
package main

import (
    "fmt"
    "stock-go/stockData"
    "stock-go/stockStrategy/strategies"
    "stock-go/tradeTest"
)

func main() {
    // 1. 加载股票列表
    stockData.LoadPreStockList()
    fmt.Printf("股票列表加载完成，共 %d 只股票\n", len(stockData.StockList))

    // 2. 创建策略1（使用默认参数）
    strategy := strategies.NewBuyHighSellLowStrategy()

    // 3. 创建回测引擎（初始资金100万）
    engine := tradeTest.NewBacktestEngine(1000000.0, strategy)

    // 4. 执行回测
    result := engine.Run()

    // 5. 查看结果
    fmt.Printf("最终现金: %.2f\n", result.Wallet.Cash)
    fmt.Printf("交易股票数量: %d\n", len(result.OperateRecords))
}
```

### 2. 使用自定义参数

```go
package main

import (
    "stock-go/stockData"
    "stock-go/stockStrategy/strategies"
    "stock-go/tradeTest"
)

func main() {
    stockData.LoadPreStockList()

    // 创建自定义参数的策略
    strategy := strategies.NewBuyHighSellLowStrategyWithParams(
        300,  // 选股器：回看300天
        10,   // 选股器：最近10天出现高点
        200,  // 信号生成器：回看200天
        0.08, // 信号生成器：止损8%
        20,   // 信号生成器：最多持有20天
    )

    engine := tradeTest.NewBacktestEngine(500000.0, strategy)
    result := engine.Run()
}
```

### 3. 自定义策略组合

```go
package main

import (
    "stock-go/stockData"
    "stock-go/stockStrategy"
    "stock-go/stockStrategy/selectors"
    "stock-go/stockStrategy/signals"
    "stock-go/tradeTest"
)

// 自定义策略结构
type MyCustomStrategy struct {
    selector  stockStrategy.StockSelector
    signalGen stockStrategy.SignalGenerator
}

func (s *MyCustomStrategy) GetSelector() stockStrategy.StockSelector {
    return s.selector
}

func (s *MyCustomStrategy) GetSignalGenerator() stockStrategy.SignalGenerator {
    return s.signalGen
}

func (s *MyCustomStrategy) GetName() string {
    return "我的自定义策略"
}

func main() {
    stockData.LoadPreStockList()

    // 创建自定义策略：全市场选股 + 追涨杀跌信号
    myStrategy := &MyCustomStrategy{
        selector:  selectors.NewAllMarketSelector(),
        signalGen: signals.NewBuyHighSellLowSignal(250, 0.05, 10),
    }

    engine := tradeTest.NewBacktestEngine(1000000.0, myStrategy)
    result := engine.Run()
}
```

## 核心概念

### 策略 = 选股器 + 信号生成器

1. **选股器 (StockSelector)**
   - 负责从全市场筛选出符合条件的股票代码列表
   - 只在回测开始时调用一次
   - 接口方法：
     - `SelectStocks(allCodes []string) []string`
     - `GetName() string`

2. **信号生成器 (SignalGenerator)**
   - 对单只股票的历史数据，逐日判断买入/卖出信号
   - 每只股票回测前调用 `Reset()` 清空状态
   - 每天调用 `ProcessDay()` 返回信号（1=买入，-1=卖出，0=无操作）
   - 接口方法：
     - `Reset()`
     - `ProcessDay(dayData, dateIndex, position) int`
     - `GetName() string`

3. **完整策略 (Strategy)**
   - 组合选股器和信号生成器
   - 接口方法：
     - `GetSelector() StockSelector`
     - `GetSignalGenerator() SignalGenerator`
     - `GetName() string`

## 内置组件

### 选股器 (Selectors)

#### 1. AllMarketSelector - 全市场选股
```go
selector := selectors.NewAllMarketSelector()
// 返回所有股票代码
```

#### 2. HighPointSelector - 高点选股
```go
selector := selectors.NewHighPointSelector(
    500,  // 回看500天
    15,   // 最近15天内出现高点
)
// 返回在过去500天内，最近15天出现最高点的股票
```

### 信号生成器 (Signals)

#### 1. BuyHighSellLowSignal - 追涨杀跌信号
```go
signal := signals.NewBuyHighSellLowSignal(
    300,  // 回看300天
    0.06, // 止损6%
    15,   // 最多持有15天
)
// 买入条件：价格达到过去300天的最高价
// 卖出条件：亏损超过6% 或 持有超过15天
```

### 完整策略 (Strategies)

#### 1. BuyHighSellLowStrategy - 追涨杀跌策略
```go
// 默认参数
strategy := strategies.NewBuyHighSellLowStrategy()

// 自定义参数
strategy := strategies.NewBuyHighSellLowStrategyWithParams(
    500,  // 选股器：回看天数
    15,   // 选股器：最近天数
    300,  // 信号：回看天数
    0.06, // 信号：止损百分比
    15,   // 信号：最大持有天数
)
```

## 回测流程

```
开始
  ↓
1. 调用选股器获取股票代码列表
  ↓
2. 从StocksRaw加载每只股票的原始数据
  ↓
3. 对每只股票执行回测
   ├─ 3.1 调用 signalGen.Reset() 重置状态
   ├─ 3.2 逐日循环
   │   ├─ 调用 ProcessDay() 获取交易信号
   │   ├─ 信号=1且空仓 → 执行买入（使用10%现金）
   │   ├─ 信号=-1且持仓 → 执行卖出
   │   └─ 更新持有天数
   └─ 3.3 强制平仓未卖出持仓
  ↓
4. 计算组合绩效指标
  ↓
返回回测结果
```

## 回测结果

### BacktestResult 结构
```go
type BacktestResult struct {
    Wallet         globalDefine.Wallet                       // 钱包状态
    OperateRecords map[string][]globalDefine.OperateRecord   // 交易记录
    Stats          PortfolioStats                            // 统计指标
}
```

### 查看结果示例
```go
result := engine.Run()

// 基本信息
fmt.Printf("最终现金: %.2f\n", result.Wallet.Cash)
fmt.Printf("持仓数量: %d\n", len(result.Wallet.Positions))

// 遍历交易记录
for code, records := range result.OperateRecords {
    fmt.Printf("股票 %s:\n", code)
    for _, record := range records {
        fmt.Printf("  买入: %s %.2f\n",
            record.BuyOperate.OperateDate,
            record.BuyOperate.BuyPrice)
        fmt.Printf("  卖出: %s %.2f\n",
            record.SellOperate.OperateDate,
            record.SellOperate.SellPrice)
        fmt.Printf("  收益: %.2f\n", record.Profit)
    }
}
```

## 运行测试

```bash
# 运行所有测试
go test ./tradeTest/

# 运行特定测试
go test ./tradeTest/ -run TestBacktestEngineWithStrategy1

# 查看详细输出
go test ./tradeTest/ -v
```

## 扩展新策略

### 步骤1: 实现选股器

```go
// stockStrategy/selectors/mySelector.go
package selectors

type MySelector struct {
    // 参数
}

func NewMySelector() *MySelector {
    return &MySelector{}
}

func (s *MySelector) SelectStocks(allCodes []string) []string {
    // 实现选股逻辑
    var selected []string
    // ...
    return selected
}

func (s *MySelector) GetName() string {
    return "我的选股器"
}
```

### 步骤2: 实现信号生成器

```go
// stockStrategy/signals/mySignal.go
package signals

import (
    "stock-go/stockData"
    "stock-go/stockStrategy"
)

type MySignal struct {
    // 参数和内部状态
    historyData []float32
}

func NewMySignal() *MySignal {
    return &MySignal{
        historyData: make([]float32, 0),
    }
}

func (sg *MySignal) Reset() {
    // 清空状态
    sg.historyData = sg.historyData[:0]
}

func (sg *MySignal) ProcessDay(
    dayData *stockData.StockDataDay,
    dateIndex int,
    position *stockStrategy.Position,
) int {
    // 1. 更新内部状态
    sg.historyData = append(sg.historyData, dayData.PriceA)

    // 2. 判断买入
    if position == nil {
        if /* 买入条件 */ {
            return 1
        }
    }

    // 3. 判断卖出
    if position != nil {
        if /* 卖出条件 */ {
            return -1
        }
    }

    return 0
}

func (sg *MySignal) GetName() string {
    return "我的信号"
}
```

### 步骤3: 组合成完整策略

```go
// stockStrategy/strategies/myStrategy.go
package strategies

import (
    "stock-go/stockStrategy"
    "stock-go/stockStrategy/selectors"
    "stock-go/stockStrategy/signals"
)

type MyStrategy struct {
    selector  stockStrategy.StockSelector
    signalGen stockStrategy.SignalGenerator
}

func NewMyStrategy() *MyStrategy {
    return &MyStrategy{
        selector:  selectors.NewMySelector(),
        signalGen: signals.NewMySignal(),
    }
}

func (s *MyStrategy) GetSelector() stockStrategy.StockSelector {
    return s.selector
}

func (s *MyStrategy) GetSignalGenerator() stockStrategy.SignalGenerator {
    return s.signalGen
}

func (s *MyStrategy) GetName() string {
    return "我的策略"
}
```

### 步骤4: 使用新策略

```go
strategy := strategies.NewMyStrategy()
engine := tradeTest.NewBacktestEngine(1000000.0, strategy)
result := engine.Run()
```

## 注意事项

### 防止未来函数

**错误示例❌**：
```go
func (sg *MySignal) ProcessDay(...) int {
    // 错误：直接访问未来数据
    futurePrice := dayDatas[dateIndex+10].PriceA
    // 这在实盘中是不可能的！
}
```

**正确示例✅**：
```go
func (sg *MySignal) ProcessDay(
    dayData *stockData.StockDataDay,
    dateIndex int,
    position *stockStrategy.Position,
) int {
    currentPrice := dayData.PriceA

    // 1. 先更新历史数据
    sg.historyPrices = append(sg.historyPrices, currentPrice)

    // 2. 只使用历史数据做决策（不包括未来）
    maxPrice := findMax(sg.historyPrices[:len(sg.historyPrices)-1])

    if currentPrice > maxPrice {
        return 1 // 买入
    }
    return 0
}
```

### 状态隔离

每只股票回测前必须调用 `Reset()`：
```go
// 回测引擎会自动处理
signalGen.Reset() // 清空历史状态
for i := 0; i < len(dayDatas); i++ {
    signal := signalGen.ProcessDay(dayData, i, position)
    // ...
}
```

### 资金管理

当前默认使用10%现金买入：
```go
// tradeTest/backtestEngine.go
cashToUse := float64(wallet.Cash) * 0.1
stockNum := int(cashToUse / price / 100) * 100 // 整手买入
```

可以修改此比例或实现更复杂的仓位管理策略。

## 文件结构

```
stock-go/
├── stockStrategy/
│   ├── interfaces.go                    # 接口定义
│   ├── selectors/                       # 选股器
│   │   ├── allMarketSelector.go
│   │   └── highPointSelector.go
│   ├── signals/                         # 信号生成器
│   │   └── buyHighSellLowSignal.go
│   └── strategies/                      # 完整策略
│       └── buyHighSellLowStrategy.go
├── tradeTest/
│   ├── backtestEngine.go                # 回测引擎
│   └── backtestEngine_test.go           # 测试用例
├── 回测优化.md                           # 详细设计方案
└── 使用指南.md                           # 本文档
```

## 常见问题

### Q: 如何只测试部分股票？

A: 实现自定义选股器：
```go
type LimitedSelector struct {
    maxCount int
}

func (s *LimitedSelector) SelectStocks(allCodes []string) []string {
    if len(allCodes) > s.maxCount {
        return allCodes[:s.maxCount]
    }
    return allCodes
}
```

### Q: 如何调整买入金额？

A: 修改 `backtestEngine.go` 中的 `executeBuy()` 方法：
```go
// 改为使用20%现金
cashToUse := float64(wallet.Cash) * 0.2
```

### Q: 如何添加更多卖出条件？

A: 在信号生成器的 `isSellSignal()` 方法中添加：
```go
func (sg *MySignal) isSellSignal(currentPrice float32, position *stockStrategy.Position) bool {
    // 原有条件
    if dropPercent >= sg.SellDropPercent {
        return true
    }

    // 新增条件：止盈15%
    gainPercent := float64(currentPrice-position.BuyPrice) / float64(position.BuyPrice)
    if gainPercent >= 0.15 {
        return true
    }

    return false
}
```

## 下一步计划

- [ ] 添加更多选股器（板块、技术指标等）
- [ ] 添加更多信号生成器（均线、MACD等）
- [ ] 实现参数优化功能
- [ ] 添加风险管理模块
- [ ] 实现多策略组合
- [ ] 对接实盘交易接口
